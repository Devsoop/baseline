{%- style -%}
  /* ── Outer clip window: exactly one viewport tall ───────────────────── */
  .animation-hero-{{ section.id }} {
    height: 100vh;
    overflow: hidden;
    position: relative;
    margin-top: -110px;

  }

  /* ── The full section body: 200vh, gradient red (top) → black (bottom) ─
     Hero lives on the red half, Polyphenols on the black half.
     When this slides up 100vh the black half enters the viewport.        */
  .animation-hero-{{ section.id }} .animation-hero__track {
    height: 300vh;
    width: 100%;
    will-change: transform;
    position: relative;

    background-image: url('https://cdn.shopify.com/s/files/1/0942/1144/0963/files/Group_15.png?v=1770036645');
    background-size: 100% 200vh;
  }

  /* ── Hero panel: top 100vh of the track (sits on the red area) ───────── */
  .animation-hero-{{ section.id }} .animation-hero__hero {
    height: 100vh;
    width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  /* ── Polyphenols panel: bottom 100vh of the track (sits on black area) ── */
  .animation-hero-{{ section.id }} .animation-hero__polyphenols {
    height: 100vh;
    width: 100%;
    position: relative;
    display: grid;
    gap: 2rem;
    align-items: center;
    padding-top: 0;
    padding-bottom: 0;
  }
  @media (min-width: 990px) {
    .animation-hero-{{ section.id }} .animation-hero__polyphenols {
      grid-template-columns: 66.6% 33%;
      gap: 1rem;
    }
  }

  /* ── Linear fade at the bottom of the hero image ───────────────────── */
  .animation-hero-{{ section.id }} .hero-bg-linear {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    background: linear-gradient(
      180deg,
      rgba(0,0,0,0)    0%,
      rgba(0,0,0,0.15) 35%,
      rgba(0,0,0,0.6)  55%,
      #000000          70%,
      #000000          100%
    );
    pointer-events: none;
  }

  /* ── Word-split helpers ─────────────────────────────────────────────── */
  .anim-word-wrap {
    display: inline-block;
    vertical-align: bottom;
  }
  .anim-word {
    display: inline-block;
    will-change: transform;
  }
  .animation-hero-{{ section.id }} .animation-hero__title-clip {
    overflow: hidden;
    display: block;
  }
{%- endstyle -%}

<section
  class="animation-hero animation-hero-{{ section.id }}"
  id="AnimationHero-{{ section.id }}"
  data-section-id="{{ section.id }}"
>
  <div class="animation-hero__track">
    <!-- PART 1 · Hero (red top half) -->
    <div class="animation-hero__hero page-width">
      <div class="hero-bg-linear" aria-hidden="true"></div>

      <div class="animation-hero__hero-content">
        {%- if section.settings.hero_heading != blank -%}
          <div class="animation-hero__title-clip" aria-hidden="true">
            <h1 class="animation-hero__title">{{ section.settings.hero_heading }}</h1>
          </div>
        {%- endif -%}
        {%- if section.settings.hero_button_text != blank -%}
          <a
            href="{{ section.settings.hero_button_link | default: '#' }}"
            class="animation-hero__btn animation-hero__btn--outline animation-hero__hero-cta"
          >
            {{ section.settings.hero_button_text }}
          </a>
        {%- endif -%}
      </div>

      {%- if section.settings.hero_banner_image != blank or section.settings.hero_banner_image_mobile != blank -%}
        <div class="animation-hero__banner">
          <div class="animation-hero__banner-img-wrap">
            {%- assign mobile_img = section.settings.hero_banner_image_mobile -%}
            {%- assign desktop_img = section.settings.hero_banner_image -%}
            {%- if mobile_img != blank and desktop_img != blank -%}
              <picture>
                <source media="(max-width: 749px)" srcset="{{ mobile_img | image_url: width: 800 }}">
                <img
                  src="{{ desktop_img | image_url: width: 1200 }}"
                  alt="{{ desktop_img.alt | default: 'Hero banner' }}"
                  class="animation-hero__banner-img"
                  loading="lazy"
                  width="{{ desktop_img.width }}"
                  height="{{ desktop_img.height }}"
                >
              </picture>
            {%- elsif mobile_img != blank -%}
              {{
                mobile_img
                | image_url: width: 800
                | image_tag: loading: 'lazy', class: 'animation-hero__banner-img', alt: mobile_img.alt | default: 'Hero banner'
              }}
            {%- else -%}
              {{
                desktop_img
                | image_url: width: 1200
                | image_tag: loading: 'lazy', class: 'animation-hero__banner-img', alt: desktop_img.alt | default: 'Hero banner'
              }}
            {%- endif -%}
          </div>
        </div>
      {%- endif -%}
    </div>

    <!-- PART 2 · Polyphenols (black bottom half) -->
    <div class="animation-hero__polyphenols page-width">
      <div class="animation-hero__polyphenols-content">
        {%- if section.settings.polyphenols_heading != blank -%}
          <h2 class="animation-hero__polyphenols-title">{{ section.settings.polyphenols_heading }}</h2>
        {%- endif -%}
        {%- if section.settings.polyphenols_text != blank -%}
          <div class="animation-hero__polyphenols-text rte">
            {{ section.settings.polyphenols_text }}
          </div>
        {%- endif -%}
        {%- if section.settings.polyphenols_button_text != blank -%}
          <a
            href="{{ section.settings.polyphenols_button_link | default: '#' }}"
            class="animation-hero__btn animation-hero__btn--outline"
          >
            {{ section.settings.polyphenols_button_text }}
          </a>
        {%- endif -%}
      </div>

      {%- if section.settings.polyphenols_image != blank -%}
        <div class="animation-hero__polyphenols-media">
          {{
            section.settings.polyphenols_image
            | image_url: width: 600
            | image_tag:
              loading: 'lazy',
              class: 'animation-hero__polyphenols-img',
              alt: section.settings.polyphenols_image.alt
            | default: 'Polyphenols'
          }}
        </div>
      {%- endif -%}
    </div>
  </div>
</section>

<style>
  .animation-hero {
    color: #fff;
  }
  .animation-hero__hero-content {
    position: relative;
    z-index: 2;
  }
  .animation-hero__title {
    margin: 0 0 1.5rem;
    font-size: 100px;
    font-weight:400;
    text-transform: uppercase;
    line-height: 100%;
    letter-spacing:2%;
    color: white;
  }
  .animation-hero__btn {
    display: inline-block;
    padding: 0.75rem 40px;
    font-size: 18px;
    font-weight: 700;
    line-height:136%;
    text-transform: uppercase;
    letter-spacing: 1.3px;
    text-decoration: none;
    color: #fff;
    transition: opacity 0.2s;
    will-change: transform, opacity;
  }
  .animation-hero__btn:hover { opacity: 0.9; }
  .animation-hero__btn--outline {
    border: 2px solid #fff;
    border-radius: 9999px;
  }
  .animation-hero__banner {
    position: absolute;
    inset: 0;
    pointer-events: none;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3;
    max-width: 80%;
    margin: auto;
  }
  .animation-hero__banner-img-wrap {
    width: 100%;
    will-change: transform, opacity;
    margin-top: 100px;
  }
  .animation-hero__banner-img {
    width: 100%;
    height: auto;
    display: block;
  }
  .animation-hero__polyphenols-title {
    margin: 0 0 1rem;
    font-size: 52px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: white;
  }
  @media (max-width: 550px) {
    .animation-hero__polyphenols-title { font-size: 32px !important; }
    .animation-hero__polyphenols-text  { font-size: 16px !important; }
  }
  .animation-hero__polyphenols-text {
    margin-bottom: 1.5rem;
    font-size: 24px;
    line-height: 200%;
    letter-spacing: 0%;
  }
  .animation-hero__polyphenols-text strong { font-weight: 700; }

  /* ── Line-animation clip rows ───────────────────────────────────────── */
  .poly-line-outer {
    display: block;
    overflow: hidden;
    line-height: inherit;
  }
  .poly-line-inner {
    display: block;
  }

  .animation-hero__polyphenols-media {
    max-width: 280px;
    margin-left: auto;
    margin-right: auto;
  }
  @media (min-width: 990px) {
    .animation-hero__polyphenols-media { max-width: 320px; }
  }
  .animation-hero__polyphenols-img {
    width: 100%;
    height: auto;
    display: block;
  }
  @media screen and (max-width: 991px) {
    .animation-hero__btn { font-size: 14px; text-align: center; }
    .animation-hero-{{ section.id }} .animation-hero__title { font-size: 82px; }
  }
  @media screen and (max-width: 500px) {
    .animation-hero-{{ section.id }} .animation-hero__title { font-size: 46px; }
  }
  @media screen and (max-width: 749px) {
    .animation-hero-{{ section.id }} .animation-hero__banner { max-width: 100%; }
  }
</style>

<script>
  (function () {
    function loadScript(src, cb) {
      if (document.querySelector('script[src="' + src + '"]')) { cb(); return; }
      var s = document.createElement('script');
      s.src = src; s.onload = cb;
      document.head.appendChild(s);
    }

    loadScript('https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js', function () {
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js', function () {
        init();
      });
    });

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function init() {
      if (typeof gsap === 'undefined') return;
      gsap.registerPlugin(ScrollTrigger);

      var section = document.getElementById('AnimationHero-{{ section.id }}');
      if (!section) return;

      ScrollTrigger.getAll().forEach(function (st) {
        if (st.trigger && section.contains(st.trigger)) st.kill();
      });

      var track     = section.querySelector('.animation-hero__track');
      var heroTitle = section.querySelector('.animation-hero__title');
      var heroCta   = section.querySelector('.animation-hero__hero-cta');
      var bannerWrap = section.querySelector('.animation-hero__banner-img-wrap');
      var header    = document.querySelector(
        'sticky-header, .header-wrapper, #shopify-section-header, .site-header, header.header'
      );

      /* ── Split hero title into animated words ── */
      var wordEls = [];
      if (heroTitle) {
        var rawText = heroTitle.innerText != null ? heroTitle.innerText : heroTitle.textContent || '';
        var words = rawText.trim().split(/\s+/).filter(Boolean);
        heroTitle.innerHTML = words
          .map(function (w) {
            return '<span class="anim-word-wrap"><span class="anim-word">' + escapeHtml(w) + '</span></span>';
          })
          .join(' ');
        wordEls = Array.from(heroTitle.querySelectorAll('.anim-word')).reverse();
      }

      /* ── Build line-wrapped DOM for polyphenols text ── */
      /* Strategy:
         1. Temporarily make the element visible & in-flow so offsetTop is real.
         2. Wrap every text node word in an inline span.
         3. Measure each span's offsetTop relative to the container.
         4. Group spans that share the same offsetTop → one visual line.
         5. Replace each group with:
              <span class="poly-line-outer">   ← overflow:hidden clip
                <span class="poly-line-inner"> ← slides up from y:100%
                  …words…
                </span>
              </span>
         This way we animate full visual lines, not individual words.
      */
      var polyTextEl  = section.querySelector('.animation-hero__polyphenols-text');
      var lineInners  = [];   /* will hold every .poly-line-inner for GSAP */

      if (polyTextEl) {

        /* 1. Wrap text nodes only — preserves <strong> etc. */
        (function wrapTextNodes(el) {
          var walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null, false);
          var nodes = []; var n;
          while ((n = walker.nextNode())) nodes.push(n);
          nodes.forEach(function (tn) {
            var tokens = tn.nodeValue.split(/(\s+)/);
            if (tokens.length <= 1) return;
            var frag = document.createDocumentFragment();
            tokens.forEach(function (tok) {
              if (!tok.trim()) {
                frag.appendChild(document.createTextNode(tok));
              } else {
                var sp = document.createElement('span');
                sp.className = 'poly-word-tmp';
                sp.style.cssText = 'display:inline;';
                sp.textContent = tok;
                frag.appendChild(sp);
              }
            });
            tn.parentNode.replaceChild(frag, tn);
          });
        })(polyTextEl);

        /* 2. Force layout so offsetTop values are correct */
        void polyTextEl.offsetHeight;

        /* 3. Gather all word spans and measure offsetTop relative to polyTextEl */
        var allTmpWords = Array.from(polyTextEl.querySelectorAll('.poly-word-tmp'));
        var containerOffsetTop = polyTextEl.getBoundingClientRect().top;

        var lineMap = [];   /* [{top, words:[el,…]}, …] */
        allTmpWords.forEach(function (w) {
          var wTop = Math.round(w.getBoundingClientRect().top - containerOffsetTop);
          var last = lineMap[lineMap.length - 1];
          if (last && Math.abs(last.top - wTop) < 6) {
            last.words.push(w);
          } else {
            lineMap.push({ top: wTop, words: [w] });
          }
        });

        /* 4. For every detected visual line, build outer/inner wrapper spans */
        lineMap.forEach(function (line) {
          var firstWord = line.words[0];
          var parent    = firstWord.parentNode;

          /* outer clip */
          var outer = document.createElement('span');
          outer.className = 'poly-line-outer';

          /* inner slider */
          var inner = document.createElement('span');
          inner.className = 'poly-line-inner';

          /* Insert outer before first word of this line */
          parent.insertBefore(outer, firstWord);

          /* Move each word (+ any preceding whitespace text node) into inner */
          line.words.forEach(function (w) {
            var prev = w.previousSibling;
            if (prev && prev.nodeType === 3 && /^\s+$/.test(prev.nodeValue)) {
              inner.appendChild(prev);   /* grab the space */
            }
            inner.appendChild(w);
          });

          outer.appendChild(inner);
          lineInners.push(inner);
        });

        /* 5. Remove temporary class from word spans (keep them inline) */
        polyTextEl.querySelectorAll('.poly-word-tmp').forEach(function (sp) {
          sp.classList.remove('poly-word-tmp');
        });

        /* 6. Start all line-inners hidden below their clip */
        gsap.set(lineInners, { y: '110%', opacity: 0 });
      }

      /* ── Main timeline ── */
      var tl = gsap.timeline({
        scrollTrigger: {
          trigger: section,
          start: 'top top',
          end: '+=400%',
          pin: true,
          scrub: 2.2,
          anticipatePin: 1,
          snap: {
            snapTo: function (progress) { return progress < 0.3 ? 0 : 1; },
            duration: 3,
            ease: 'power2.inOut',
          },
        },
      });

      /* Phase 1 — hero title words exit downward */
      var wordPhaseDuration = wordEls.length ? 0.9 + (wordEls.length - 1) * 0.45 : 0;
      if (wordEls.length) {
        tl.fromTo(
          wordEls,
          { y: 0 },
          { y: 100, stagger: 0.45, ease: 'power3.in', duration: 0.9 },
          0
        );
      }
      if (heroCta) {
        tl.to(heroCta, { filter: 'blur(10px)', opacity: 0, ease: 'power2.in', duration: 0.6 }, 0);
      }
      if (bannerWrap) {
        tl.to(bannerWrap, { scale: 2.55, opacity: 0, ease: 'power2.inOut', duration: 1.0 }, 0);
      }
      if (header) {
        tl.to(header, { yPercent: -120, ease: 'power2.in', duration: 0.5 }, 0.5);
      }

      /* Phase 2 — track slides UP, polyphenols panel enters */
      tl.to(
        track,
        { y: '-100vh', ease: 'power3.inOut', duration: 1.0 },
        Math.max(1.0, wordPhaseDuration)
      );

      /* Phase 3 — hold + line-by-line text reveal */
      var holdStart   = Math.max(1.0, wordPhaseDuration) + 1.0;
      var totalBeats  = lineInners.length;                          /* 1 beat per line */
      var holdTotal   = 1.0;                                        /* total hold duration */
      var perBeat     = totalBeats > 0 ? holdTotal / (totalBeats + 1) : holdTotal;

      tl.to({}, { duration: holdTotal }, holdStart);               /* the hold itself */

      if (lineInners.length) {
        /* First 2 lines appear together as beat 0 */
        var firstTwo = lineInners.slice(0, 2);
        tl.to(
          firstTwo,
          { y: '0%', opacity: 1, ease: 'power2.out', duration: perBeat * 1.3 },
          holdStart
        );

        /* Remaining lines one by one */
        lineInners.slice(2).forEach(function (inner, i) {
          tl.to(
            inner,
            { y: '0%', opacity: 1, ease: 'power2.out', duration: perBeat * 1.3 },
            holdStart + (i + 1) * perBeat
          );
        });
      }

      /* Header returns as polyphenols panel settles */
      if (header) {
        tl.to(header, { yPercent: 0, ease: 'power2.out', duration: 0.8 }, Math.max(1.0, wordPhaseDuration) + 0.4);
      }

      /* Cleanup */
      ScrollTrigger.create({
        trigger: section,
        start: 'top top',
        end: '+=500%',
        onLeave: function () {
          if (header) gsap.set(header, { clearProps: 'all' });
          if (heroCta) gsap.set(heroCta, { clearProps: 'all' });
        },
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Animation hero",
  "tag": "section",
  "class": "section-animation-hero",
  "settings": [
    { "type": "header", "content": "Hero area" },
    { "type": "text", "id": "hero_heading", "label": "Hero heading", "default": "Health in every drop" },
    { "type": "text", "id": "hero_button_text", "label": "Hero button text", "default": "Try baseline" },
    { "type": "url", "id": "hero_button_link", "label": "Hero button link" },
    { "type": "header", "content": "Hero banner image" },
    { "type": "image_picker", "id": "hero_banner_image", "label": "Banner image (desktop)" },
    { "type": "image_picker", "id": "hero_banner_image_mobile", "label": "Banner image (mobile)" },
    { "type": "header", "content": "Powered by Polyphenols" },
    {
      "type": "text",
      "id": "polyphenols_heading",
      "label": "Polyphenols heading",
      "default": "Powered by polyphenols"
    },
    {
      "type": "richtext",
      "id": "polyphenols_text",
      "label": "Polyphenols text",
      "default": "<p>Polyphenols are <strong>potent antioxidants</strong> that help protect your body from <strong>free radicals</strong> and <strong>oxidative stress</strong>.</p>"
    },
    {
      "type": "text",
      "id": "polyphenols_button_text",
      "label": "Polyphenols button text",
      "default": "Take the 3-minute polyphenol journey"
    },
    { "type": "url", "id": "polyphenols_button_link", "label": "Polyphenols button link" },
    { "type": "image_picker", "id": "polyphenols_image", "label": "Polyphenols graphic (e.g. droplet / GIF)" },
    { "type": "header", "content": "Section padding" },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 300,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 36
    }
  ],
  "presets": [{ "name": "Animation hero" }]
}
{% endschema %}
