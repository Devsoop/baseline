
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>

{%- style -%}
  #BaselineStory-{{ section.id }} {
    position: relative;
    min-height: 100vh;
    overflow: hidden;
    background: linear-gradient(180deg, rgba(107, 2, 17, 0) 0%, #000000 70.02%) !important;
  }
  
  #BaselineStory-{{ section.id }}.baseline-story {
    background: linear-gradient(180deg, rgba(107, 2, 17, 0) 0%, #000000 70.02%) !important;
  }

  #BaselineStory-{{ section.id }} .baseline-story__app {
    position: absolute;
    inset: 0;
    overflow: hidden;
  }

  #BaselineStory-{{ section.id }} .baseline-story__bg {
    position: absolute;
    inset: 0;
    z-index: 0;
  }

  #BaselineStory-{{ section.id }} .baseline-story__ruler {
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: 32px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    padding: 12px 0;
    overflow: hidden;
  }

  #BaselineStory-{{ section.id }} .ruler-line {
    position: absolute;
    right: 0;
    top: 12px; bottom: 12px;
    width: 1px;
    background: rgba(255,255,255,0.3);
  }

  #BaselineStory-{{ section.id }} .tick {
    position: absolute;
    right: 0;
    height: 1px;
    background: rgba(255,255,255,0.5);
  }
  #BaselineStory-{{ section.id }} .tick.major { width: 10px; }
  #BaselineStory-{{ section.id }} .tick.minor { width: 5px; }

  #BaselineStory-{{ section.id }} .baseline-story__ruler-fill {
    position: absolute;
    right: 0;
    top: 12px;
    width: 2px;
    height: 0%;
    background: #c0392b;
    transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 6px rgba(192,57,43,0.6);
  }

  #BaselineStory-{{ section.id }} .baseline-story__slides {
    position: absolute;
    inset: 0;
    z-index: 5;
  }

  #BaselineStory-{{ section.id }} .baseline-story__slide {
    position: absolute;
    inset: 0;
    padding: 60px clamp(24px, 5vw, 80px) 40px;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: clamp(40px, 8vw, 80px);
    opacity: 0;
    pointer-events: none;
  }

  #BaselineStory-{{ section.id }} .baseline-story__slide-inner {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: clamp(40px, 8vw, 80px);
    max-width: 850px;
    width: 100%;
    margin: 0 auto;
  }

  #BaselineStory-{{ section.id }} .baseline-story__slide-content {
    flex: 1;
    min-width: 0;
    margin-top: -400px;
  }

  #BaselineStory-{{ section.id }} .baseline-story__slide-media {
    flex: 1;
    min-width: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (max-width: 749px) {
    #BaselineStory-{{ section.id }} .baseline-story__slide,
    #BaselineStory-{{ section.id }} .baseline-story__slide-inner {
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
    }
    #BaselineStory-{{ section.id }} .baseline-story__slide-media {
      width: 100%;
      justify-content: flex-start;
    }
  }

  #BaselineStory-{{ section.id }} .slide-eyebrow {
    font-size: 18px;
    font-weight: 700;
    font-style: italic;
    color: #fff;
    margin-bottom: 18px;
    display: block;
    opacity: 0;
    transform: translateY(20px);
  }

  #BaselineStory-{{ section.id }} .slide-lines {
    display: flex;
    gap: 0;
    flex-direction: column;
  }

  #BaselineStory-{{ section.id }} .line-wrap {
    overflow: hidden;
    padding-bottom: 2px;
    width: 100%;
  }

  #BaselineStory-{{ section.id }} .line-inner {
    display: inline-block;
    width: 100%;
    font-size: 18px;
    font-weight: 400;
    color: #fff;
    line-height: 1.55;
    opacity: 0;
    transform: translateY(100%);
    white-space: normal;
  }

  #BaselineStory-{{ section.id }} .line-inner strong { font-weight: 700; color: #fff; }
  #BaselineStory-{{ section.id }} .line-inner em { font-style: italic; font-weight: 700; }

  #BaselineStory-{{ section.id }} .slide-img-area {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  #BaselineStory-{{ section.id }} .illus-img,
  #BaselineStory-{{ section.id }} .illus-img.placeholder-svg {
    width: 100%;
    max-width: 320px;
    height: auto;
    object-fit: contain;
    opacity: 0;
    transform: translateY(50px);
    filter: drop-shadow(0 20px 40px rgba(0,0,0,0.7));
    display: block;
  }

  #BaselineStory-{{ section.id }} .baseline-story__scroll-hint {
    position: absolute;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 80;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    opacity: 0;
  }

  #BaselineStory-{{ section.id }} .baseline-story__scroll-hint span {
    font-size: 9px;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.3);
  }

  #BaselineStory-{{ section.id }} .hint-arrow {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    animation: baselineStoryBounce 1.6s ease-in-out infinite;
  }

  #BaselineStory-{{ section.id }} .hint-arrow i {
    display: block;
    width: 1px;
    height: 6px;
    background: rgba(255,255,255,0.3);
  }

  #BaselineStory-{{ section.id }} .hint-arrow svg {
    width: 10px;
    height: 6px;
    fill: none;
    stroke: rgba(255,255,255,0.3);
    stroke-width: 1.5;
  }

  @keyframes baselineStoryBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(5px); }
  }

  #BaselineStory-{{ section.id }} .baseline-story__progress-dots {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 80;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  #BaselineStory-{{ section.id }} .pdot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: rgba(255,255,255,0.18);
    transition: background 0.4s, transform 0.4s;
  }
  #BaselineStory-{{ section.id }} .pdot.active {
    background: #fff;
    transform: scale(1.5);
  }
{%- endstyle -%}

<section id="BaselineStory-{{ section.id }}" class="baseline-story">
  <div class="baseline-story__app">

    <div class="baseline-story__bg"></div>

    <div class="baseline-story__ruler" data-ruler>
      <div class="ruler-line"></div>
      <div class="baseline-story__ruler-fill" data-ruler-fill></div>
    </div>

    <div class="baseline-story__progress-dots" data-dots>
      {%- for block in section.blocks -%}
        <div class="pdot{% if forloop.first %} active{% endif %}" data-i="{{ forloop.index0 }}"></div>
      {%- endfor -%}
    </div>

    <div class="baseline-story__slides">
      {%- for block in section.blocks -%}
        {%- assign lines_str = block.settings.description | default: '' -%}
        {%- assign lines = lines_str | newline_to_br | split: '<br />' -%}
        <div class="baseline-story__slide text-slide" data-slide data-slide-index="{{ forloop.index0 }}" {{ block.shopify_attributes }}>
          <div class="baseline-story__slide-inner">
            <div class="baseline-story__slide-content">
              <span class="slide-eyebrow">{{ block.settings.heading | default: 'Slide' }}</span>
              <div class="slide-lines" data-lines>
                {%- for line in lines -%}
                  <div class="line-wrap">
                    {%- if line != blank -%}
                      <span class="line-inner">{{ line }}</span>
                    {%- else -%}
                      <span class="line-inner">&nbsp;</span>
                    {%- endif -%}
                  </div>
                {%- endfor -%}
              </div>
            </div>
            <div class="baseline-story__slide-media">
              <div class="slide-img-area">
                {%- if block.settings.image != blank -%}
                  <img
                    class="illus-img"
                    src="{{ block.settings.image | image_url: width: 640 }}"
                    alt="{{ block.settings.image.alt | default: '' | escape }}"
                    width="320"
                    height="400"
                    loading="lazy"
                  >
                {%- else -%}
                  {{ 'image' | placeholder_svg_tag: 'illus-img placeholder-svg' }}
                {%- endif -%}
              </div>
            </div>
          </div>
        </div>
      {%- endfor -%}
    </div>

    <div class="baseline-story__scroll-hint" data-scroll-hint>
      <span>{{ section.settings.scroll_hint_text | default: 'Scroll' }}</span>
      <div class="hint-arrow">
        <i></i><i></i>
        <svg viewBox="0 0 10 6"><polyline points="1,1 5,5 9,1"/></svg>
      </div>
    </div>

  </div>
</section>

<script>
(function() {
  const section = document.getElementById('BaselineStory-{{ section.id }}');
  if (!section) return;

  const app = section.querySelector('.baseline-story__app');
  const ruler = section.querySelector('[data-ruler]');
  const rulerFill = section.querySelector('[data-ruler-fill]');
  const dots = section.querySelectorAll('.pdot');
  const slides = section.querySelectorAll('[data-slide]');
  const TOTAL = slides.length;

  if (TOTAL === 0) return;

  // Ruler ticks
  const rulerHeight = section.offsetHeight;
  const numTicks = 40;
  for (let i = 0; i <= numTicks; i++) {
    const t = document.createElement('div');
    t.className = 'tick ' + (i % 5 === 0 ? 'major' : 'minor');
    t.style.top = (12 + (i / numTicks) * (rulerHeight - 24)) + 'px';
    ruler.appendChild(t);
  }

  let current = 0;
  let isAnimating = false;

  function updateRuler(idx) {
    rulerFill.style.height = ((idx + 1) / TOTAL * 100) + '%';
  }

  function updateDots(idx) {
    dots.forEach((d, i) => d.classList.toggle('active', i === idx));
  }

  function exitSlide(idx, tl) {
    const slide = slides[idx];
    if (slide) tl.to(slide, { y: -30, opacity: 0, duration: 0.4, ease: 'power2.in' }, 0);
  }

  function enterSlide(idx, tl, offset) {
    const slide = slides[idx];
    if (!slide) return;

    const eyebrow = slide.querySelector('.slide-eyebrow');
    const lines = slide.querySelectorAll('.line-inner');
    const illus = slide.querySelector('.illus-img');

    gsap.set(slide, { opacity: 0, y: 0 });
    if (eyebrow) gsap.set(eyebrow, { opacity: 0, y: 20 });
    if (lines.length) gsap.set(lines, { opacity: 0, y: '100%' });
    if (illus) gsap.set(illus, { opacity: 0, y: 50 });

    tl.to(slide, { opacity: 1, duration: 0.01 }, offset)
      .to(eyebrow, { opacity: 1, y: 0, duration: 0.4, ease: 'power2.out' }, offset + 0.1);

    if (lines.length) {
      const linesDelay = offset + 0.2;
      const staggerTime = 0.08;
      const lineDuration = 0.3;
      tl.to(lines, { opacity: 1, y: '0%', duration: lineDuration, stagger: staggerTime, ease: 'power2.out' }, linesDelay);
      if (illus) {
        const imageStartDelay = linesDelay + Math.floor(lines.length / 2) * staggerTime + lineDuration * 0.5;
        tl.to(illus, { opacity: 1, y: 0, duration: 0.6, ease: 'power2.out' }, imageStartDelay);
      }
    } else if (illus) {
      tl.to(illus, { opacity: 1, y: 0, duration: 0.6, ease: 'power2.out' }, offset + 0.3);
    }
  }

  function goTo(next) {
    if (isAnimating || next === current || next < 0 || next >= TOTAL) return;
    isAnimating = true;
    const prev = current;
    current = next;
    updateDots(next);
    updateRuler(next);

    const tl = gsap.timeline({ onComplete: () => { isAnimating = false; } });
    exitSlide(prev, tl);
    enterSlide(next, tl, 0.3);
  }

  let lastWheel = 0;
  window.addEventListener('wheel', e => {
    if (!app.contains(e.target)) return;
    e.preventDefault();
    const now = Date.now();
    if (isAnimating || now - lastWheel < 120) return;
    lastWheel = now;
    goTo(current + (e.deltaY > 0 ? 1 : -1));
  }, { passive: false });

  let touchY = 0;
  section.addEventListener('touchstart', e => { touchY = e.touches[0].clientY; }, { passive: true });
  section.addEventListener('touchend', e => {
    const dy = touchY - e.changedTouches[0].clientY;
    if (Math.abs(dy) < 40) return;
    const now = Date.now();
    if (isAnimating || now - lastWheel < 400) return;
    lastWheel = now;
    goTo(current + (dy > 0 ? 1 : -1));
  }, { passive: true });

  section.addEventListener('keydown', e => {
    if (!app.contains(document.activeElement) && !section.contains(document.activeElement)) return;
    if (e.key === 'ArrowDown' || e.key === ' ') { e.preventDefault(); goTo(current + 1); }
    if (e.key === 'ArrowUp') { e.preventDefault(); goTo(current - 1); }
  });

  function init() {
    if (typeof gsap === 'undefined') return setTimeout(init, 50);
    gsap.set(slides, { opacity: 0 });
    updateRuler(0);
    updateDots(0);
    const tl = gsap.timeline({ onComplete: () => { isAnimating = false; } });
    isAnimating = true;
    enterSlide(0, tl, 0.3);
    const hint = section.querySelector('[data-scroll-hint]');
    if (hint) gsap.to(hint, { opacity: 1, duration: 0.8, delay: 1.8, ease: 'power2.out' });
  }

  if (document.readyState === 'complete') setTimeout(init, 200);
  else window.addEventListener('load', () => setTimeout(init, 200));
})();
</script>

{% schema %}
{
  "name": "Baseline Story",
  "tag": "section",
  "class": "section-baseline-story",
  "settings": [
    {
      "type": "text",
      "id": "scroll_hint_text",
      "label": "Scroll hint text",
      "default": "Scroll"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Slide"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "default": "Add your content here.\nEach line animates in.",
          "info": "Each line animates in. Use blank lines for spacing."
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Baseline Story",
      "blocks": [
        { "type": "slide" },
        { "type": "slide" }
      ]
    }
  ]
}
{% endschema %}
